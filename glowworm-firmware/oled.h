




#define SCREEN_WIDTH 128  // OLED display width, in pixels
#define SCREEN_HEIGHT 64  // OLED display height, in pixels

#define OLED_ADDR 0x3C
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT);

#if (SSD1306_LCDHEIGHT != 64)
//#error("Height incorrect, please fix Adafruit_SSD1306.h!");
#endif



int logoW = 127;
int logoH = 42;

const unsigned char practLogo[] PROGMEM = {
  // 'practable-new-logo-big-font', 128x42px
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x03, 0xc0, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x07, 0x80, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x07, 0x80, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x0f, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x0e, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x60, 0x00,
  0x00, 0x00, 0x1e, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x06, 0x00, 0x60, 0x00,
  0x00, 0x00, 0x1e, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x06, 0x00, 0x60, 0x00,
  0x03, 0xff, 0x9e, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x06, 0x00, 0x60, 0x00,
  0x03, 0xff, 0xcf, 0x00, 0x0f, 0x3f, 0x0f, 0xe7, 0xe0, 0x7e, 0x7e, 0x1f, 0x86, 0xf8, 0x61, 0xf8,
  0x07, 0xff, 0xe7, 0x00, 0x0e, 0x7f, 0x8f, 0xcf, 0xf0, 0xff, 0x7e, 0x3f, 0xc7, 0xfc, 0x63, 0xfc,
  0x0f, 0x00, 0xe7, 0x80, 0x1e, 0xe1, 0xce, 0x0c, 0x39, 0xc3, 0x38, 0x70, 0xc7, 0x0e, 0x63, 0x0e,
  0x0e, 0x00, 0xf3, 0x80, 0x3c, 0xc0, 0xce, 0x1c, 0x19, 0x80, 0x38, 0x60, 0x66, 0x06, 0x67, 0x06,
  0x1e, 0x00, 0x73, 0xc0, 0x38, 0xc0, 0xcc, 0x18, 0x19, 0x80, 0x18, 0x60, 0x66, 0x06, 0x67, 0xfe,
  0x1c, 0x00, 0x79, 0xff, 0xf8, 0xc0, 0xcc, 0x18, 0x1d, 0x80, 0x18, 0x60, 0x66, 0x06, 0x67, 0xfc,
  0x3c, 0x00, 0x3d, 0xff, 0xf0, 0xc0, 0xcc, 0x1c, 0x1d, 0x80, 0x18, 0x60, 0xe6, 0x06, 0x63, 0x00,
  0x78, 0x00, 0x1c, 0xff, 0xf0, 0xe1, 0xcc, 0x0c, 0x3c, 0xc2, 0x18, 0x70, 0xe3, 0x0e, 0x63, 0x84,
  0x78, 0x00, 0x1e, 0x00, 0x00, 0xff, 0x8c, 0x0f, 0xfc, 0xff, 0x1e, 0x3f, 0xe3, 0xfc, 0x79, 0xfc,
  0x78, 0x00, 0x1e, 0x00, 0x00, 0xdf, 0x0c, 0x03, 0xe8, 0x7e, 0x0e, 0x1f, 0x60, 0xf8, 0x38, 0xf8,
  0x38, 0x00, 0x3c, 0xff, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x3c, 0x00, 0x39, 0xff, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x08, 0x04, 0x00, 0x00, 0x20, 0x00,
  0x1c, 0x00, 0x7b, 0xff, 0xf8, 0xc0, 0x00, 0x00, 0x30, 0x00, 0x0b, 0x44, 0x00, 0x00, 0x20, 0x00,
  0x1e, 0x00, 0x73, 0x80, 0x38, 0xcb, 0x0c, 0x30, 0x33, 0x98, 0x68, 0x64, 0x63, 0x86, 0x20, 0x00,
  0x0f, 0x00, 0xf7, 0x80, 0x3c, 0x0f, 0xbe, 0xf8, 0x33, 0xbc, 0xfb, 0x65, 0xf7, 0xcf, 0x20, 0x00,
  0x07, 0xff, 0xe7, 0x00, 0x1c, 0x08, 0xa2, 0xc9, 0x32, 0x66, 0x8b, 0x45, 0x1e, 0x78, 0xa0, 0x00,
  0x07, 0xff, 0xef, 0x00, 0x1e, 0x08, 0xa2, 0xcb, 0xb2, 0x62, 0x8b, 0x65, 0x1e, 0x78, 0xa0, 0x00,
  0x03, 0xff, 0xce, 0x00, 0x0f, 0x08, 0xb6, 0xc8, 0x12, 0x36, 0xdb, 0x65, 0xb2, 0x6d, 0xa0, 0x00,
  0x01, 0xff, 0x9e, 0x00, 0x07, 0x08, 0x9c, 0x88, 0x1a, 0x1e, 0x70, 0x34, 0xe0, 0x07, 0xb0, 0x00,
  0x00, 0x00, 0x1c, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x1e, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98, 0x00, 0x60, 0x00, 0x00, 0x80,
  0x00, 0x00, 0x0e, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x60, 0x00, 0x00, 0x80,
  0x00, 0x00, 0x0f, 0x00, 0x1e, 0x00, 0x00, 0x3c, 0xef, 0x1d, 0xd3, 0xcf, 0x62, 0x4b, 0xce, 0x90,
  0x00, 0x00, 0x07, 0x80, 0x1c, 0x00, 0x00, 0x66, 0x89, 0xa0, 0x92, 0x19, 0x61, 0x6a, 0x68, 0xf0,
  0x00, 0x00, 0x07, 0x80, 0x3c, 0x00, 0x00, 0x46, 0x98, 0xa0, 0x92, 0x11, 0xe1, 0xfe, 0x28, 0xe0,
  0x00, 0x00, 0x03, 0xc0, 0x38, 0x00, 0x00, 0x66, 0x99, 0xa0, 0x92, 0x19, 0xe1, 0xb6, 0x68, 0xf0,
  0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x7c, 0x8f, 0xbc, 0xd3, 0xcf, 0xa0, 0x93, 0xc8, 0x90,
  0x00, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};



void show_splash() {
  // Dont know what this does
  // SSD1306_SWITCHCAPVCC = generate display voltage from 3.3V internally
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {  // Address 0x3C for 128x32
    Serial.println(F("SSD1306 allocation failed"));
    for (;;)
      ;  // Don't proceed, loop forever
  } else {
    Serial.println(F("OLED Allocated"));
  }
  display.setTextColor(SSD1306_WHITE);
  display.clearDisplay();
  if (SHOW_SPASH_SCREEN) {
    display.drawBitmap(0, 20, practLogo, logoW, logoH, 1);  //(x , y bitMap, width, height, color)
    display.display();

    delay(1000);
    display.invertDisplay(true);
    delay(500);
    display.invertDisplay(false);
  }
}

// Lines per CHAR at 1.5 = 16
// yellow band = 16 lines

// for old stats screen
/*
#define COL_0 0
#define COL_1 30
#define COL_2 65
#define COL_3 95

#define ROW_0 6
#define ROW_1 16
#define ROW_2 27
#define ROW_3 40
#define ROW_4 50
*/

void old_stats_screen() {
  /*
  display.setCursor(COL_0, ROW_1);
  display.print(F("Pbus"));
  display.setCursor(COL_1, ROW_1);
  display.print(adj_V_buf);

  display.setCursor(COL_0, 27);
  display.print(F("Iexp:"));
  display.setCursor(COL_1, ROW_2);
  display.print(adj_I_buf);

  display.setCursor(COL_2, ROW_2);
  display.print(F("Wexp:"));
  display.setCursor(COL_3, ROW_2);
  display.print(exp_W_buf);

  display.setCursor(COL_0, ROW_3);
  display.print(F("Vsbc:"));
  display.setCursor(COL_1, ROW_3);
  display.print(sbc_V_buf);

  display.setCursor(COL_0, ROW_4);
  display.print(F("Isbc:"));
  display.setCursor(COL_1, ROW_4);
  display.print(sbc_I_buf);

  display.setCursor(COL_2, ROW_4);
  display.print(F("Wsbc:"));
  display.setCursor(COL_3, ROW_4);
  display.print(sbc_W_buf);
  */
}

// for new stats screen
#define BOX_WIDTH 60
#define BOX_HEIGHT 45
#define BOX_RADIUS 2

#define COL_0 2
#define COL_1 36
#define COL_2 128 - BOX_WIDTH
#define COL_3 92

#define ROW_0 2
//#define ROW_1 16  // minimum to stop clipping the yellow
#define ROW_1 18
#define ROW_2 29
#define ROW_3 40
#define ROW_4 51




const char UI_text[][8] = {
  "leds",
  "blnd",
  "Hue",
  "Sat",
  "Brt",
  "Hue",
  "Sat",
  "Brt"
};

const uint8_t UI_text_X[8] = {
  60,
  60,
  COL_0,
  COL_0,
  COL_0,
  COL_2,
  COL_2,
  COL_2
};

const uint8_t UI_text_Y[8] = {
  0,
  8,
  ROW_2,
  ROW_3,
  ROW_4,
  ROW_2,
  ROW_3,
  ROW_4
};


void led_stats_screen() {
  display.setTextColor(WHITE);

  char val_buffer[8][8];


  itoa(currentLED.num_leds, val_buffer[0], 10);
  strcpy(val_buffer[1], blendNames[currentLED.blend]);
  itoa(currentLED.ch_A_hue, val_buffer[2], 10);
  itoa(currentLED.ch_A_sat, val_buffer[3], 10);
  itoa(currentLED.ch_A_bright, val_buffer[4], 10);
  itoa(currentLED.ch_B_hue, val_buffer[5], 10);
  itoa(currentLED.ch_B_sat, val_buffer[6], 10);
  itoa(currentLED.ch_B_bright, val_buffer[7], 10);

  //  Serial.println(val_buffer[0]);
  // Serial.println(val_buffer[1]);



  char printBuffer[24];


  //  channel A Header & border
  display.drawRoundRect(0, 16, BOX_WIDTH, BOX_HEIGHT, 3, WHITE);  // x, y, w, h, rad, colour
  display.setCursor(COL_0, ROW_1);
  display.print(F("CH:A "));

  // do channel B Header & border
  display.drawRoundRect(126 - BOX_WIDTH, 16, BOX_WIDTH, BOX_HEIGHT, 3, WHITE);  // x, y, w, h, rad, colour
  display.setCursor(COL_2, ROW_1);
  display.print(F("CH:B "));

  // function to print all the UI text, highlighting the active one
  // delay(5000);
  for (int i = 0; i < 8; i++) {  // loop through all the arrays printing each value in the place specified
    display.setCursor(UI_text_X[i], UI_text_Y[i]);

    if (i != active_stat) {
      display.setTextColor(WHITE);
      sprintf(printBuffer, "%s:%5s", UI_text[i], val_buffer[i]);
      display.print(printBuffer);
    } else {

      if (select_mode) {
        if (i < 2) {  // the first 2 menu options are longer and need a longer box printed
          display.fillRoundRect(UI_text_X[i] - 1, UI_text_Y[i] - 1, 32, 10, 2, WHITE);
        } else {  // last 2 options are shorter and need shorter box
          display.fillRoundRect(UI_text_X[i] - 1, UI_text_Y[i] - 1, 28, 10, 2, WHITE);
        }
        display.setTextColor(BLACK);              // print half the text in black
        sprintf(printBuffer, "%s:", UI_text[i]);  //  ;, val_buffer[i]);%5s"
        display.print(printBuffer);
        display.setTextColor(WHITE);                 // print half the text in white
        sprintf(printBuffer, "%5s", val_buffer[i]);  //  ;, );%5s"
        display.print(printBuffer);

      } else {        // else we are not in select mode, the whole item should be highlighted
        if (i < 2) {  // the first 2 menu options are longer and need a longer box printed
          display.fillRoundRect(UI_text_X[i] - 1, UI_text_Y[i] - 1, 64, 10, 2, WHITE);
        } else {  // last 2 options are shorter and need shorter box
          display.fillRoundRect(UI_text_X[i] - 1, UI_text_Y[i] - 1, 56, 10, 2, WHITE);
        }
        display.setTextColor(BLACK);  // print all text in black
        sprintf(printBuffer, "%s:%5s", UI_text[i], val_buffer[i]);
        display.print(printBuffer);
      }
    }
  }
}



//void fillRoundRect(int16_t x0, int16_t y0, int16_t w, int16_t h,
//                    int16_t radius, uint16_t color);

void battery_indicator(uint8_t batteryLevel = 4) {
  display.setTextColor(WHITE);
  display.setCursor(1, 9);  // x, y
  display.print(F("Batt:"));
  // Always draw outline
  display.drawRoundRect(32, 10, 16, 6, 1, WHITE);  // x, y, w, h, rad, colour
  display.drawRoundRect(47, 11, 3, 4, 1, WHITE);
  if (batteryLevel > 0) {
    display.fillRoundRect(32, 10, 4, 6, 1, WHITE);  // x, y, w, h, rad, colour
  }
  if (batteryLevel > 1) {
    display.fillRoundRect(37, 10, 4, 6, 1, WHITE);  // x, y, w, h, rad, colour
  }
  if (batteryLevel > 2) {
    display.fillRoundRect(42, 10, 4, 6, 1, WHITE);  // x, y, w, h, rad, colour
  }
  if (batteryLevel > 3) {
    display.fillRoundRect(47, 11, 3, 4, 1, WHITE);  // x, y, w, h, rad, colour
  }
}

void update_oled() {  // char *Vexp, char *Iexp, char *Vsbc, char *Isbc, char *sbcTrig, char *extTrig, char *expTrig, char *sbcReboot, char *expReboot) {
  display.clearDisplay();
  // display.setTextSize(1.9);  // Draw 2X-scale text

  display.setTextColor(BLACK);
  // display.fillRoundRect(0, 0, 128, 15, 2, WHITE);  // x, y, w, h, colour // full bar
  display.fillRoundRect(0, 0, 50, 9, 2, WHITE);  // x, y, w, h, colour // full bar
  // display.setFont(&FreeMonoBold9pt7b);
  display.setCursor(1, 1);  //(x,y) (COL, ROW)
  display.print(F("GlowWorm"));
  display.setCursor(1, 7);  //(x,y) (COL, ROW)
                            //  display.setTextColor(WHITE);
                            // char printBuffer[24];
  //sprintf(printBuffer, "          Blend: %s", blendNames[currentBlend]);
  // display.print(printBuffer);

  // display.setTextSize(1.9);  // Draw 2X-scale text
  battery_indicator(battery_indicator_level);
  led_stats_screen();


  display.display();
}
